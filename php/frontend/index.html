<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Nova Compra</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
</head>
<body>
<div class="container mt-4">
  <h3>Nova compra</h3>
  <form id="pedidoForm">
    <div class="mb-3">
      <label for="produtoId" class="form-label">Produto</label>
      <input class="form-control" name="produto" id="produtoId">
    </div>
    <button class="btn btn-primary" type="submit">Salvar</button>
  </form>

  <hr>
  <h3>Status</h3>
  <button class="btn btn-secondary mb-2" onclick="atualizar()">Atualizar</button>
  <table class="table table-striped" id="table">
    <thead>
      <tr>
        <th>Id</th>
        <th>Produtos</th>
        <th>Distribuidor</th>
        <th>Email</th>
        <th>Pagamento</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  // Form submit
  document.getElementById('pedidoForm').addEventListener('submit', function(event) {
    event.preventDefault();
    salvar();
  });

  function salvar() {
    const produto = document.getElementById('produtoId').value;
    const ajax = new XMLHttpRequest();
    ajax.open("POST", "http://localhost:9191/store", true);
    ajax.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    ajax.onreadystatechange = function() {
      if (ajax.readyState === 4 && ajax.status === 200) {
        const data = JSON.parse(ajax.responseText);
        console.log('Resposta do servidor:', data);
        alert(data.rabbit_status || 'Pedido enviado!');
        atualizar();
      }
    };
    ajax.send("produto=" + encodeURIComponent(produto));
  }

  function atualizar() {
    const ajax = new XMLHttpRequest();
    ajax.open("GET", "http://localhost:9191/", true);
    ajax.onreadystatechange = function() {
      if (ajax.readyState === 4 && ajax.status === 200) {
        const data = JSON.parse(ajax.responseText);
        popularTabela(data.pedidos || data);
      }
    };
    ajax.send();
  }

  function popularTabela(pedidos) {
    const table = document.getElementById('table');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = ''; // Limpa o conteúdo

    pedidos.forEach(pedido => {
      const row = tbody.insertRow();
      row.insertCell().textContent = pedido.id || '';
      row.insertCell().textContent = pedido.produtos || '';
      row.insertCell().textContent = pedido.distributor || '';
      row.insertCell().textContent = pedido.email || '';
      row.insertCell().textContent = pedido.payment || '';
    });
  }

  // Atualiza a cada 7 segundos
  setInterval(() => atualizar(), 7000);
  
  // Atualiza ao carregar a página
  window.onload = atualizar;
</script>
</body>
</html>
